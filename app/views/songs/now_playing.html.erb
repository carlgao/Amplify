
<script type="text/javascript">
document.body.onload = function() {
	var canvas = document.getElementById("paper");
	var context = canvas.getContext("2d");
	var width = 320;
	var height = 480;

	canvas.width = width;
	canvas.height = height;

	var backgroundImg = new Image();
	backgroundImg.onload = function() {};
	backgroundImg.src = "/images/background.png";

	var ratingWheelImg = new Image();
	ratingWheelImg.src = "/images/vinyl.png";

	var ratingWheel = new cObject();
	var rwl = 225;
	ratingWheel.visible = true;
	ratingWheel.width = rwl;
	ratingWheel.height = rwl; 
	ratingWheel.x = width/2;
	ratingWheel.y = height - 2*rwl/3;
	ratingWheel.draw = (function() {
		context.save();
		context.translate(ratingWheel.x, ratingWheel.y);
		context.rotate(r);
		context.drawImage(ratingWheelImg, -rwl/2, -rwl/2, 
				ratingWheel.width, ratingWheel.height);
		context.restore();
	}).bind(this);

	var meterImg = new Image();
	meterImg.src = "/images/meter.png";

	var meter = new cObject();
	mw = 300;
	mh = 200;
	meter.visible = true;
	meter.width = mw;
	meter.height = mh;
	meter.x = width/2;
	meter.y = 16+mh/2;
	meter.draw = (function() {
		context.save();
		context.translate(meter.x, meter.y);
		context.drawImage(meterImg, -mw/2, -mh/2,
			meter.width, meter.height);
		context.restore();
	}).bind(this);

	var needleImg = new Image();
	needleImg.src = "/images/needle.png";

	var needle = new cObject();
	nw = 10;
	nh = 100;
	needle.visible = true;
	needle.width = nw;
	needle.height = nh;
	needle.x = width/2;
	needle.y = meter.y + mh/4;
	needle.draw = (function() {
		context.save();
		context.translate(needle.x, needle.y);
		context.drawImage(needleImg, -nw/2, -nh+2,
			needle.width, needle.height);
		context.restore();
	}).bind(this);
	
	// CALLBACK FUNCTIONS
	var r = 0;	// rotation
	// starts timed draw events
	setInterval((function() {
		context.clearRect(0,0,width,height);	// clear the rectangle first
		context.drawImage(backgroundImg, 0, 0, width, height);
		ratingWheel.draw();
		meter.draw();
		needle.draw();
	}).bind(this), 1000/30);	// 30 fps

	// touch handlers
	document.addEventListener("touchmove", function(event) {
		// handle one finger touches
		switch(event.targetTouches.length) {
		case 1:
			var touch = event.targetTouches[0];
			// figure out if the touch is within bounds of the rating wheel
			if(ratingWheel.isHovering(touch.pageX+rwl/2, touch.pageY+rwl/2)) {
				// find a new rotation angle		
				var angle = Math.atan((height-rwl+rwl/2 - touch.pageY)/(touch.pageX - width/2)) - Math.PI/2;
				if(touch.pageX - width/2 < 0) {
					angle = angle - Math.PI;
				}
				r = -1*angle;
			} else {	// if it's not hovering any objects, lets say it's a swipe
				
			}
			break;
		default:
			break;
		}
		// stop the touches from moving the screen
		event.preventDefault();
	}, false);
};

</script>

<canvas id="paper"></canvas>

<!-- canvas contains everything
<% song = @now_playing_song %>
<% if song == nil %>
  <tr>No songs currently playing</tr>
<% else %>
    <td><%= song.id %></td>
    <td><%= song.name %></td>
    <td><%= song.requests %></td>
    <td><%= song.upvotes %></td>
    <td><%= song.downvotes %></td>
    <td><%= song.playing %></td>
    <td><%= song.hotness %></td>
    <td><%= link_to 'Show', song %></td>
    <td><button id="<%= song.id %>" class="upvote-btn btn success">Upvote</button></td>
    <td><button id="<%= song.id %>" class="downvote-btn btn danger">Downvote</button></td>
    <td><%= link_to 'Edit', edit_song_path(song) %></td>
    <td><%= link_to 'Destroy', song, :confirm => 'Are you sure?', :method => :delete %></td>
  </tr>
<% end %>
</table>
-->
